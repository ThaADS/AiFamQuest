name: Integration Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: famquest_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: famquest_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://famquest_test:test_password@localhost:5432/famquest_test
      REDIS_URL: redis://localhost:6379
      JWT_SECRET: test_jwt_secret_key_for_integration_tests
      ENVIRONMENT: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-timeout

      - name: Run database migrations
        working-directory: ./backend
        run: |
          # Run Alembic migrations if available
          if [ -f "alembic.ini" ]; then
            alembic upgrade head
          fi

      - name: Run backend integration tests
        working-directory: ./backend
        run: |
          pytest tests/integration/ \
            -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junit-xml=junit-results.xml \
            --timeout=300
        continue-on-error: false

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: backend-integration
          name: backend-integration-coverage

      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: backend-integration-test-results
          path: |
            ./backend/junit-results.xml
            ./backend/htmlcov/

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const xml2js = require('xml2js');

            // Parse JUnit XML results
            const xmlData = fs.readFileSync('./backend/junit-results.xml', 'utf8');
            const parser = new xml2js.Parser();

            parser.parseString(xmlData, (err, result) => {
              if (err) {
                console.log('Error parsing XML:', err);
                return;
              }

              const testsuite = result.testsuites.testsuite[0].$;
              const tests = parseInt(testsuite.tests);
              const failures = parseInt(testsuite.failures);
              const errors = parseInt(testsuite.errors);
              const skipped = parseInt(testsuite.skipped);
              const time = parseFloat(testsuite.time).toFixed(2);

              const passed = tests - failures - errors - skipped;
              const passRate = ((passed / tests) * 100).toFixed(1);

              const comment = `## üß™ Backend Integration Test Results

              | Metric | Value |
              |--------|-------|
              | ‚úÖ Passed | ${passed}/${tests} (${passRate}%) |
              | ‚ùå Failed | ${failures} |
              | ‚ö†Ô∏è Errors | ${errors} |
              | ‚è≠Ô∏è Skipped | ${skipped} |
              | ‚è±Ô∏è Duration | ${time}s |

              ${failures + errors > 0 ? '‚ùå **Tests failed!** Please review and fix.' : '‚úÖ **All tests passed!**'}
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            });

  flutter-integration-tests:
    name: Flutter Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Install Flutter dependencies
        working-directory: ./flutter_app
        run: flutter pub get

      - name: Analyze Flutter code
        working-directory: ./flutter_app
        run: flutter analyze

      - name: Run Flutter integration tests (headless)
        working-directory: ./flutter_app
        run: |
          # Install Chrome for headless testing
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

          # Run integration tests
          flutter test integration_test/ --coverage
        continue-on-error: true  # Allow Flutter tests to fail without blocking

      - name: Upload Flutter coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          file: ./flutter_app/coverage/lcov.info
          flags: flutter-integration
          name: flutter-integration-coverage

      - name: Upload Flutter test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: flutter-integration-test-results
          path: ./flutter_app/test-results/

  integration-coverage-check:
    name: Integration Coverage Check
    runs-on: ubuntu-latest
    needs: [backend-integration-tests, flutter-integration-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend coverage
        uses: actions/download-artifact@v3
        with:
          name: backend-integration-test-results
          path: ./backend-coverage

      - name: Check coverage threshold
        run: |
          # Parse coverage percentage from coverage.xml
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' ./backend-coverage/coverage.xml | head -1)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc)

          echo "Integration test coverage: ${COVERAGE_PERCENT}%"

          # Fail if coverage < 80%
          if (( $(echo "$COVERAGE_PERCENT < 80" | bc -l) )); then
            echo "‚ùå Integration test coverage (${COVERAGE_PERCENT}%) is below 80% threshold"
            exit 1
          else
            echo "‚úÖ Integration test coverage (${COVERAGE_PERCENT}%) meets 80% threshold"
          fi

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [backend-integration-tests, flutter-integration-tests, integration-coverage-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## üìä Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Integration | ${{ needs.backend-integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter Integration | ${{ needs.flutter-integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Check | ${{ needs.integration-coverage-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.backend-integration-tests.result }}" == "success" && "${{ needs.integration-coverage-check.result }}" == "success" ]]; then
            echo "‚úÖ **All integration tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some integration tests failed. Please review.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail workflow if tests failed
        if: needs.backend-integration-tests.result != 'success' || needs.integration-coverage-check.result != 'success'
        run: exit 1
