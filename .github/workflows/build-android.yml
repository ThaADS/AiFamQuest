name: Build Android APK

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: Install Flutter dependencies
        working-directory: flutter_app
        run: flutter pub get

      - name: Analyze code
        working-directory: flutter_app
        run: flutter analyze --no-fatal-infos --no-fatal-warnings || true

      - name: Run tests
        working-directory: flutter_app
        run: flutter test

      - name: Build debug APK
        working-directory: flutter_app
        run: flutter build apk --debug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: flutter_app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      - name: Build split APKs (per ABI)
        working-directory: flutter_app
        run: flutter build apk --debug --split-per-abi

      - name: Upload Split APKs
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-split-apks
          path: flutter_app/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: Create Build Summary
        run: |
          echo "## âœ… Android Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- **app-debug.apk** (Universal, ~50-70MB)" >> $GITHUB_STEP_SUMMARY
          echo "- **app-arm64-v8a-debug.apk** (ARM 64-bit, ~20-30MB)" >> $GITHUB_STEP_SUMMARY
          echo "- **app-armeabi-v7a-debug.apk** (ARM 32-bit, ~20-30MB)" >> $GITHUB_STEP_SUMMARY
          echo "- **app-x86_64-debug.apk** (Intel 64-bit, ~25-35MB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“² Installation Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download APK from Artifacts section above" >> $GITHUB_STEP_SUMMARY
          echo "2. Transfer to Android device" >> $GITHUB_STEP_SUMMARY
          echo "3. Enable 'Install from Unknown Sources'" >> $GITHUB_STEP_SUMMARY
          echo "4. Install APK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Recommended APK:" >> $GITHUB_STEP_SUMMARY
          echo "- **Modern devices (2019+)**: app-arm64-v8a-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Older devices (<2019)**: app-armeabi-v7a-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Unknown architecture**: app-debug.apk (universal)" >> $GITHUB_STEP_SUMMARY

  # Release build job (commented out until signing keys are configured)
  # Uncomment and add secrets to enable release builds
  # build-release:
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/master'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.35.3'
  #         channel: 'stable'
  #         cache: true
  #     - name: Install dependencies
  #       working-directory: flutter_app
  #       run: flutter pub get
  #     - name: Create key.properties
  #       working-directory: flutter_app/android
  #       run: |
  #         echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > key.properties
  #         echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> key.properties
  #         echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> key.properties
  #         echo "storeFile=release-keystore.jks" >> key.properties
  #     - name: Decode keystore
  #       working-directory: flutter_app/android
  #       run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release-keystore.jks
  #     - name: Build Release APK
  #       working-directory: flutter_app
  #       run: flutter build apk --release --split-per-abi
  #     - name: Upload Release APKs
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: app-release-apks
  #         path: flutter_app/build/app/outputs/flutter-apk/*.apk
  #         retention-days: 90
